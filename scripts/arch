#!/usr/bin/env bash

# curl --proto '=https' --tlsv1.2 -LsSf https://raw.githubusercontent.com/iovis/dotfiles/master/scripts/arch | bash
set -euo pipefail

export DOTFILES="$HOME/.dotfiles"
export PACMAN_PATH="$DOTFILES/pacman/.config/pacman"
export LOCAL_BIN="$HOME/.local/bin"
export PROJECT_HOME="$HOME/code/"
export PATH="$LOCAL_BIN:$PATH"

echo "[$(date '+%Y-%m-%d %H:%M')] Installing Libraries"
sudo pacman -Syu --noconfirm
sudo pacman -S --needed --noconfirm git

if [ ! -d "$DOTFILES" ]; then
  echo "[$(date '+%Y-%m-%d %H:%M')] Installing Dotfiles"
  git clone https://github.com/iovis/dotfiles "$DOTFILES"
fi

sudo pacman -S --needed $(cat "$PACMAN_PATH/Pacfile")

if ! command -v paru >/dev/null 2>&1; then
  echo "[$(date '+%Y-%m-%d %H:%M')] Installing paru"

  mkdir -p "$PROJECT_HOME"

  git clone https://aur.archlinux.org/paru-bin.git "$PROJECT_HOME/paru/"

  cd "$PROJECT_HOME/paru/" || exit
  makepkg -si --noconfirm
  cd - || exit

  rm -rf "$PROJECT_HOME/paru/"
fi

paru -S --needed $(cat "$PACMAN_PATH/Parufile")

echo "[$(date '+%Y-%m-%d %H:%M')] Starting services"
sudo systemctl enable --now avahi-daemon bluetooth fstrim.timer gdm reflector.timer sshd

echo "[$(date '+%Y-%m-%d %H:%M')] Stow"
cd "$DOTFILES" || exit
stow bat fish fzf git hyprland kitty lazygit mangohud mise mpv muxi nvim pacman qutebrowser starship stylua swaync tldr tmux vicinae vim waybar wezterm
cd - || exit

echo "[$(date '+%Y-%m-%d %H:%M')] Installing mise"
if ! command -v mise >/dev/null 2>&1; then
  curl https://mise.run | sh
fi

mise install -y

echo "[$(date '+%Y-%m-%d %H:%M')] Installing rust"
if ! command -v cargo >/dev/null 2>&1; then
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
fi

. "$HOME/.cargo/env"
cargo install cargo-binstall
cargo binstall -y $(cat "$DOTFILES/default/crates")

echo "[$(date '+%Y-%m-%d %H:%M')] Reflector settings"
sudo cp "$DOTFILES/scripts/extra/reflector.conf" /etc/xdg/reflector/reflector.conf

# if [ ! -f "/usr/lib/systemd/system-sleep/disable-some-wake" ]; then
#   echo "[$(date '+%Y-%m-%d %H:%M')] Fix for not being able to suspend"
#   sudo cp "$DOTFILES/scripts/extra/disable-some-wake" /usr/lib/systemd/system-sleep
#   sudo chmod 755 /usr/lib/systemd/system-sleep/disable-some-wake
# fi

# echo "[$(date '+%Y-%m-%d %H:%M')] Setting dark theme"
# gsettings set org.gnome.desktop.interface color-scheme prefer-dark
# gsettings set org.gnome.desktop.interface gtk-theme Adwaita-dark

echo "[$(date '+%Y-%m-%d %H:%M')] Apply monitor settings to GDM"
sudo cp ~/.config/monitors.xml /etc/xdg/monitors.xml

echo "[$(date '+%Y-%m-%d %H:%M')] Installation ended"

shell=$(basename "$SHELL")
if [ "$shell" != "fish" ]; then
  echo "**************"
  echo "$shell detected."
  echo "Run chsh -s $(which fish)"
fi
