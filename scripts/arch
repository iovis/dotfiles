#!/usr/bin/env bash

# curl --proto '=https' --tlsv1.2 -LsSf https://raw.githubusercontent.com/iovis/dotfiles/master/scripts/arch | bash
set -euo pipefail

export DOTFILES="${DOTFILES:-$HOME/.dotfiles}"
export PACMAN_PATH="${PACMAN_PATH:-$DOTFILES/pacman/.config/pacman}"
export PROJECT_HOME="${PROJECT_HOME:-$HOME/code/}"

export LOCAL_BIN="${LOCAL_BIN:-$HOME/.local/bin}"
export PATH="$LOCAL_BIN:$PATH"

echo "[$(date '+%Y-%m-%d %H:%M')] Installing Libraries"
sudo pacman -Sy --needed --noconfirm archlinux-keyring
sudo pacman -Syu --noconfirm
sudo pacman -S --needed --noconfirm git

if [ ! -d "$DOTFILES" ]; then
  echo "[$(date '+%Y-%m-%d %H:%M')] Installing Dotfiles"
  git clone https://github.com/iovis/dotfiles "$DOTFILES"
fi

# shellcheck disable=SC2046 # pacdump-generated, newline-delimited package list
sudo pacman -S --needed $(cat "$PACMAN_PATH/Pacfile")

if ! command -v yay >/dev/null 2>&1; then
  echo "[$(date '+%Y-%m-%d %H:%M')] Installing yay"

  mkdir -p "$PROJECT_HOME"

  git clone https://aur.archlinux.org/yay-bin.git "$PROJECT_HOME/yay-bin/"

  cd "$PROJECT_HOME/yay-bin/" || exit
  makepkg -si --noconfirm
  cd - || exit

  rm -rf "$PROJECT_HOME/yay-bin/"
fi

yay -Y --gendb
# shellcheck disable=SC2046 # pacdump-generated, newline-delimited package list
yay -S --needed --answerclean=none --answerdiff=none $(cat "$PACMAN_PATH/Aurfile")

echo "[$(date '+%Y-%m-%d %H:%M')] Starting services"
sudo systemctl enable --now avahi-daemon bluetooth cpupower fstrim.timer gdm reflector.timer sshd

echo "[$(date '+%Y-%m-%d %H:%M')] Stow"
cd "$DOTFILES" || exit
stow bat fish fzf git hyprland kitty lazygit mise mpv muxi nvim pacman qutebrowser starship stylua swaync tldr tmux vicinae vim waybar wezterm
cd - || exit

echo "[$(date '+%Y-%m-%d %H:%M')] Installing mise"
if ! command -v mise >/dev/null 2>&1; then
  curl https://mise.run | sh
fi

mise install -y

echo "[$(date '+%Y-%m-%d %H:%M')] Installing rust"
if ! command -v cargo >/dev/null 2>&1; then
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
fi

if [ -f "$HOME/.cargo/env" ]; then
  # shellcheck disable=SC1091 # dynamic path created by rustup installer
  . "$HOME/.cargo/env"
else
  echo "rustup env file missing at $HOME/.cargo/env" >&2
  exit 1
fi

command -v cargo >/dev/null 2>&1 || {
  echo "cargo not found after rustup setup" >&2
  exit 1
}

cargo install cargo-binstall
# shellcheck disable=SC2046 # curated newline-delimited crate list
cargo binstall -y $(cat "$DOTFILES/default/crates")

echo "[$(date '+%Y-%m-%d %H:%M')] Reflector settings"
sudo cp "$DOTFILES/scripts/extra/reflector.conf" /etc/xdg/reflector/reflector.conf

# if [ ! -f "/usr/lib/systemd/system-sleep/disable-some-wake" ]; then
#   echo "[$(date '+%Y-%m-%d %H:%M')] Fix for not being able to suspend"
#   sudo cp "$DOTFILES/scripts/extra/disable-some-wake" /usr/lib/systemd/system-sleep
#   sudo chmod 755 /usr/lib/systemd/system-sleep/disable-some-wake
# fi

# echo "[$(date '+%Y-%m-%d %H:%M')] Setting dark theme"
# gsettings set org.gnome.desktop.interface color-scheme prefer-dark
# gsettings set org.gnome.desktop.interface gtk-theme Adwaita-dark

echo "[$(date '+%Y-%m-%d %H:%M')] Apply monitor settings to GDM"
if [ -f "$HOME/.config/monitors.xml" ]; then
  sudo cp "$HOME/.config/monitors.xml" /etc/xdg/monitors.xml
else
  echo "[$(date '+%Y-%m-%d %H:%M')] monitors.xml not found; skipping"
fi

echo "[$(date '+%Y-%m-%d %H:%M')] Orphaned packages"
pacman -Qtdq || echo 'No orphaned packages'

echo "[$(date '+%Y-%m-%d %H:%M')] Installation ended"

shell=$(basename "$SHELL")
if [ "$shell" != "fish" ]; then
  echo "**************"
  echo "$shell detected."
  echo "Run chsh -s $(which fish)"
fi
